var map=new Object,mapData=new Object,mapInit=!1,mapType="production",mapLayers=[],mapColors=["rgba(202, 137, 123)","rgba(218, 160, 113)","rgba(235, 195, 107)","rgba(247, 228, 108)","rgba(223, 248, 108)","rgba(146, 231, 101)","rgba(123, 210, 131)","rgba(119, 184, 169)","rgba(106, 152, 171)","rgba(90, 111, 159)"],nfcqs={url:function(){return"http://"+document.domain},openPopUp:function(e,a){$(".modal, .fade").remove(),$.ajax({url:e,async:!0,type:"GET",data:{},datatype:"html",success:function(e){$("body").append(e),$("#popupForm").modal({backdrop:"static",keyboard:!1}),$(".pick-date").length&&$(".pick-date").each(function(){$(this).datepicker({zIndex:1e4,autoHide:!0,format:""!=a&&null!=a?a:"mm/dd/yyyy"})})}})},getUrlVars:function(e){let a={};e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,o){a[t]=o});return a},mergeCommonRows:function(e,a){for(var t=[],o=1;o<=e.find("tbody tr:nth-child(1)").find("td").length;o++){var r=null,n=null,p=1;curIndex=o,void 0===a.find(valExist)&&e.find("td:nth-child("+o+")").each(function(e,a){var i=$(this),s=i.text();r==s&&""!==s&&-1===$.inArray(e,t)?(i.addClass("hidden"),n.attr("rowspan",p+=1)):(1===o&&t.push(e),p=1,r=s,n=i)})}$("td.hidden").remove()},forecast:function(e){$(".loader-wrapper, .loading").show(),$.ajax({url:e,async:!0,type:"GET",data:{},datatype:"html",success:function(e){$(".loader-wrapper, .loading").hide(),"object"==typeof e?swal("Oops, an error occured!",{icon:"error"}):swal("Forecast data successfully generated!",{icon:"success"})}})},deleteRecord:function(e){$.ajax({url:e,async:!0,type:"GET",data:{},cache:!1,datatype:"json",success:function(e){0==e.error?(setTimeout(function(){location.reload()},3e3),swal("Record has been deleted!",{icon:"success"})):swal("Error! Unable to delete.",{icon:"error"})}})},map:{init:function(){map=new L.Map("map"),map.attributionControl.setPrefix("");var e=new L.LatLng(12,122);map.setView(e,6);e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var a=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012"}),t=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}),o=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC",maxZoom:16}),r=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"}),n=L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:19}).addTo(map).bringToBack(),p=L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),i=L.tileLayer("https://wxs.ign.fr/{apikey}/geoportail/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",{attribution:'<a target="_blank" href="https://www.geoportail.gouv.fr/">Geoportail France</a>',bounds:[[-75,-180],[81,180]],minZoom:2,maxZoom:19,apikey:"choisirgeoportail",format:"image/jpeg",style:"normal"});L.control.layers({OpenStreetMap:e,"ESRI World Street Map":a,"ESRI World Imagery":t,"ESRI National Geographic Map":o,"ESRI World Topographic Map":r,"Carto Voyager Map":n,"Open Topographic Map":p,"Geoportail France Orthos":i},{},{collapsed:!0,position:"bottomright"}).addTo(map),mapInit=!0},show:function(){let e=[],a="",t="p_c"==mapType?"Self-Sufficiency":mapType.split("_").join(" ");$(".legend-colors").html(""),$(".map-legend").find("h1").html(mapData.commodity+" • "+t+" • "+mapData.year);for(let t=0;t<mapData[mapType].length;t++)if(""!=mapData.coordinates[mapData[mapType][t].province]){let o={type:"Feature",properties:{province:mapData[mapType][t].province},geometry:{type:"MultiPolygon",coordinates:JSON.parse(mapData.coordinates[mapData[mapType][t].province])}},r=L.geoJson(o,{style:function(e){return{color:"#fff",weight:1,fillColor:mapColors[t],fillOpacity:1,fillPattern:null}},onEachFeature:function(e,a){a.on("click",function(){swal("Province of "+e.properties.province,{icon:"success"})})}}).addTo(map).bringToFront();mapLayers.push(r),e.push(r.getBounds());let n=parseFloat(mapData[mapType][t][mapType]).toFixed(2);a+='<tr><td style="padding-left:0"><b class="label-color" style="background-color:'+mapColors[t]+'"></b></td><td style="padding-left:10px">'+mapData[mapType][t].province+'</td><td style="padding-left:10px; padding-right:0; text-align:right">'+nfcqs.formatNum(n)+"</td></tr>"}0!=e.length&&map.fitBounds(e),$(".legend-colors").html("<table>"+a+"</table>"),$(".map-legend").show(),$(".current-user").remove(),$(".change-map-data").html("").show(),$(".change-map-data").append("<h1>Map Options • "+mapData.commodity+"</h1>"),"crop"==mapData.type&&($(".change-map-data").append('<label><input type="radio" name="change_map_data" value="area" /> Area</label'),$(".change-map-data").append('<label><input type="radio" name="change_map_data" value="yield" /> Yield</label')),$(".change-map-data").append('<label><input type="radio" name="change_map_data" value="production" /> Production</label'),$(".change-map-data").append('<label><input type="radio" name="change_map_data" value="per_capita_consumption" /> Per Capita Consumption</label'),$(".change-map-data").append('<label><input type="radio" name="change_map_data" value="consumption" /> Consumption</label'),$(".change-map-data").append('<label><input type="radio" name="change_map_data" value="p_c" /> Self-Sufficiency</label'),$('input[name="change_map_data"]').each(function(){let e=$(this).val();e==mapType&&$(this).prop("checked",!0)})},setType:function(e){mapType=e},clear:function(){$(mapLayers).each(function(e,a){map.removeLayer(a)}),mapLayers=[]}},formatNum:function(e){return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}};$(document).ready(function(){$(document).on("submit","form.x-load",function(a){a.preventDefault();var t=$(this);$(".loader-wrapper, .loading").css("display","block"),$('input[type="submit"], button[type="submit"]').attr("disabled","disabled"),$(".response-wrapper").html(""),$.ajax({url:$(this).attr("action"),async:!0,type:"POST",data:$(this).serialize(),datatype:"html",success:function(a){if($("span.field-error-msg").remove(),$("*").removeClass("field-error"),$(".loader-wrapper, .loading").css("display","none"),$('input[type="submit"], button[type="submit"]').removeAttr("disabled"),t.hasClass("show-map"))if($(".error-wrapper").show().html(""),1==a.error){for(e in a.msg)$(".error-wrapper").append('<span style="display:block; position:relative">'+a.msg[e]+"</span>");$(".error-wrapper").addClass("alert alert-danger")}else $(".error-wrapper").hide(),$(".container-fluid").remove(),$("html, body, #wrapper").css("height","100%"),$("#page-content-wrapper").css({padding:"0",width:"100%",height:"100%"}),$("#page-content-wrapper").append('<div class="map" id="map">...</div>'),$(".modal, .fade").remove(),0==mapInit&&nfcqs.map.init(),mapData=a,nfcqs.map.clear(),nfcqs.map.show();else if("object"==typeof a)if(1==Object.keys(a).length&&"error"in a)$(".response-wrapper").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> '+a.error+"</div>");else for(e in a){if("po_id"==e){let t=a[e];e="po_name",a[e]=t}var o=$('input[name="'+e+'"], select[name="'+e+'"], textarea[name="'+e+'"]').closest("div");o.append('<span class="field-error-msg"><i class="fas fa-level-up-alt"></i>'+a[e]+"</span>"),$('input[name="'+e+'"], select[name="'+e+'"], textarea[name="'+e+'"]').addClass("field-error")}else $('input[type="submit"], button[type="submit"]').attr("disabled","disabled"),$("h1.form-title").length?t.find("h1.form-title").after('<span class="alert alert-success"><i class="far fa-check-circle"></i>'+a+"</span>"):$("div.modal-body").length&&t.find("div.modal-body").find("div:eq(0)").before('<span class="alert alert-success"><i class="far fa-check-circle"></i>'+a+"</span>"),$(document).scrollTop(0),""!=t.data("goto")&&void 0!==t.data("goto")&&setTimeout(function(){$('input[name="contract_code"]').length>0?window.location.replace(t.data("goto")+"?search="+$('input[name="contract_code"]').val()):window.location.replace(t.data("goto"))},3e3)}})}),$(document).on("submit","form.x-load-file",function(a){a.preventDefault();var t=$(this),o=t.prop("id");$(".loader-wrapper, .loading").css("display","block"),$('input[type="submit"], button[type="submit"]').attr("disabled","disabled");var r=new FormData(document.getElementById(o));r.append("_token",$('input[name="_token"').val()),r.append("file",$('input[name="file"').val()),r.append("contractId",$('input[name="contract_id"').val()),$.ajax({url:$(this).attr("action"),async:!0,type:"POST",data:r,cache:!1,datatype:"html",processData:!1,contentType:!1,success:function(a){if($("span.field-error-msg").remove(),$("*").removeClass("field-error"),$(".loader-wrapper, .loading").css("display","none"),$('input[type="submit"], button[type="submit"]').removeAttr("disabled"),"object"==typeof a)for(e in a){var o=$('input[name="'+e+'"], select[name="'+e+'"], textarea[name="'+e+'"]').closest("div");o.append('<span class="field-error-msg"><i class="fas fa-level-up-alt"></i>'+a[e]+"</span>"),$('input[name="'+e+'"], select[name="'+e+'"], textarea[name="'+e+'"]').addClass("field-error")}else $('input[type="submit"], button[type="submit"]').attr("disabled","disabled"),$("h1.form-title").length?t.find("h1.form-title").after('<span class="alert alert-success"><i class="far fa-check-circle"></i>'+a+"</span>"):$("div.modal-body").length&&t.find("div.modal-body").find("div:eq(0)").before('<span class="alert alert-success"><i class="far fa-check-circle"></i>'+a+"</span>"),$(document).scrollTop(0),""!=t.data("goto")&&void 0!==t.data("goto")&&setTimeout(function(){window.location.replace(t.data("goto"))},3e3)}})}),$(document).on("click","a.open-popup",function(e){e.preventDefault(),nfcqs.openPopUp($(this).prop("href"),$(this).data("dateformat"))}),$(document).on("click","a.forecast",function(e){e.preventDefault();let a=$(this).prop("href");nfcqs.forecast(a)}),$(document).on("click",".delete-record",function(e){e.preventDefault();let a=$(this).prop("href");swal({title:"Delete Record",text:"Are you sure you want to delete this record?",icon:"warning",buttons:!0,dangerMode:!0}).then(e=>{e&&nfcqs.deleteRecord(a)})}),$(document).on("change",'select[name="map_commodity"]',function(e){let a=mapControlData,t=$(this).val(),o=0;$(".map-province-input-wrapper").html(". . .");for(let e=0;e<a.length;e++)if(t==a[e][0][0]){let t=a[e][1];$(".map-province-input-wrapper").html("");for(let r=0;r<t.length;r++){let t=a[e][1][r][0][0],n=a[e][1][r][0][1],p="",i="";p+='<div class="province-entry" style="margin:10px 0; padding:0"><div class="province-details"><label style="text-transform:none; font-size:12px"><input type="checkbox" name="province_input_'+o+'" value="'+t+'" /><span style="padding-left:5px">'+n+'</span></label></div><div class="province-forecasts-wrapper" style="padding-left:15px">';let s=a[e][1][r][1];for(let t=0;t<s.length;t++){let n=a[e][1][r][1][t][0],p=a[e][1][r][1][t][1];i+='<div class="forecast-details"><label style="text-transform:none; font-size:12px"><input type="radio" name="forecast_input_'+o+'" value="'+n+'" /><span style="padding-left:5px">'+p+"</span></label></div>"}o++,$(".map-province-input-wrapper").append(p+i+"</div>")}$('select[name="map_year"]').html('<option value="" selected="selected"></option>');for(let t=0;t<a[e][2].length;t++)$('select[name="map_year"]').append('<option value="'+a[e][2][t]+'">'+a[e][2][t]+"</option>")}$('input[name="province_count"]').val(o)}),$(document).on("click",'input[name^="forecast_input_"]',function(e){$(this).is(":checked")&&$(this).closest(".province-entry").find('input[type="checkbox"]').prop("checked",!0)}),$(document).on("click",'input[name="change_map_data"]',function(e){let a=$(this).val();$(this).is(":checked")&&(nfcqs.map.setType(a),nfcqs.map.show())})});